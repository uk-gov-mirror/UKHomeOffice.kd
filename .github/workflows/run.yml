on:
  push:
    branches:
    - master
    tags:
    - '*'
  pull_request:
name: Run
jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
    - name: Install Go
      uses: actions/setup-go@v6
      with:
        go-version: 1.25.3
    - name: Checkout code
      uses: actions/checkout@v5
    - name: Test
      run: make testall
    - name: Create assets
      run: make release
    - name: Build image
      run: |
        make docker-build
    - name: Scan image
      id: scan
      uses: anchore/scan-action@v7
      with:
        image: "kd:ci"
        fail-build: false
        output-format: sarif
    - name: Display Vulnerability Report
      if: always()
      run: |
        /opt/hostedtoolcache/grype/*/x64/grype kd:ci -o table || echo "Grype scan completed. Check SARIF report for details."
    - name: Upload Anchore scan SARIF report
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: ${{ steps.scan.outputs.sarif }}
    - name: Save Image
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        mkdir -p artifacts
        docker save kd:ci > artifacts/kd+ci.tar
    - name: Upload image
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: docker-artifact
        path: artifacts
    - name: Upload binaries
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: kd-binaries
        path: bin
  publish:
    if: startsWith(github.ref, 'refs/tags/')
    name: Publish assets
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Retrieve saved Docker image
        uses: actions/download-artifact@v6
        with:
          name: docker-artifact
          path: artifacts
      - name: Docker load
        run: docker load < artifacts/kd+ci.tar
      - name: Docker tag version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          docker tag kd:ci quay.io/ukhomeofficedigital/kd:${GITHUB_REF/refs\/tags\//}
          docker login quay.io -u ukhomeofficedigital+github_actions -p ${{ secrets.QUAY_PASSWORD }}
          docker push quay.io/ukhomeofficedigital/kd:${GITHUB_REF/refs\/tags\//}
      - name: Retrieve saved kd binaries
        uses: actions/download-artifact@v6
        with:
          name: kd-binaries
          path: bin
      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            bin/kd_linux_amd64
            bin/kd_darwin_amd64
            bin/kd_windows_amd64.exe
            bin/checksum.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}